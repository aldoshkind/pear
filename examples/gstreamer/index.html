<!DOCTYPE html>
<html>
  <head>
    <title>Video On Demand</title>
  </head>
  <body>
    <textarea style="width:100%; height: 200px;" id="text">
    </textarea>
    <video style='display:block; margin: 0 auto;border-style: solid;' id='remoteVideos'></video>
    <script>
      var log = msg => { console.log(msg); tx = document.getElementById('text'); tx.value += JSON.stringify(msg) + '\n';};
      var pc = new RTCPeerConnection({
        iceServers: [{urls: 'stun:stun.l.google.com:19302'}]
      });
      log('start')
      log(pc)
      function sendOfferToCall(sdp) {
        var xhttp = new XMLHttpRequest();
        xhttp.onreadystatechange = function() {
          if (this.readyState == 4 && this.status == 200) {
            let res = JSON.parse(atob(this.responseText));
            console.log(res);
            if(res.type == 'answer') {
              pc.setRemoteDescription(new RTCSessionDescription(res));
            }
          }
        };
        xhttp.open('POST', '/call/demo');
        xhttp.setRequestHeader('Content-Type', 'plain/text');
        xhttp.send(btoa(JSON.stringify({'type': 'offer', 'sdp': sdp})));
      }
      pc.ontrack = function (event) {
        log('ontrack'); log(event);
        var el = document.getElementById('remoteVideos');
        el.srcObject = event.streams[0];
        el.autoplay = true;
        el.controls = true;
        el.muted = true;
      };
      pc.oniceconnectionstatechange = e => log(pc.iceConnectionState);
      pc.onicecandidate = event => {
        if(event.candidate === null) sendOfferToCall(pc.localDescription.sdp)
      };
      pc.addTransceiver('video', {'direction': 'sendrecv'})
      pc.createOffer().then(d => pc.setLocalDescription(d)).catch(log);
    </script>
  </body>
</html>

<!--           -->

